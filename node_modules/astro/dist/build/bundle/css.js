import {performance} from "perf_hooks";
import shorthash from "shorthash";
import cheerio from "cheerio";
import esbuild from "esbuild";
import {getDistPath, getSrcPath, stopTimer} from "../util.js";
import {debug} from "../../logger.js";
const COMMON_URL = `/_astro/common-[HASH].css`;
async function bundleCSS({
  astroConfig,
  buildState,
  logging,
  depTree
}) {
  const timer = {};
  const cssMap = new Map();
  timer.bundle = performance.now();
  const sortedPages = Object.keys(depTree);
  sortedPages.sort((a, b) => a.localeCompare(b, "en", {numeric: true}));
  for (const pageUrl of sortedPages) {
    const {css} = depTree[pageUrl];
    for (const cssUrl of css.keys()) {
      if (cssMap.has(cssUrl)) {
        cssMap.set(cssUrl, COMMON_URL);
      } else {
        cssMap.set(cssUrl, "/_astro" + pageUrl.replace(/.html$/, "").replace(/^\./, "") + "-[HASH].css");
      }
    }
  }
  timer.bundle = performance.now();
  for (const id of cssMap.keys()) {
    const newUrl = cssMap.get(id);
    if (!buildState[newUrl]) {
      buildState[newUrl] = {
        srcPath: getSrcPath(id, {astroConfig}),
        contents: "",
        contentType: "text/css",
        encoding: "utf8"
      };
    }
    buildState[newUrl].contents += Buffer.isBuffer(buildState[id].contents) ? buildState[id].contents.toString("utf8") : buildState[id].contents;
    delete buildState[id];
  }
  debug(logging, "css", `bundled [${stopTimer(timer.bundle)}]`);
  timer.minify = performance.now();
  await Promise.all(Object.keys(buildState).map(async (id) => {
    if (buildState[id].contentType !== "text/css")
      return;
    const {code} = await esbuild.transform(buildState[id].contents, {
      loader: "css",
      minify: true
    });
    buildState[id].contents = code;
  }));
  debug(logging, "css", `minified [${stopTimer(timer.minify)}]`);
  timer.hashes = performance.now();
  const cssHashes = new Map();
  for (const id of Object.keys(buildState)) {
    if (!id.includes("[HASH].css"))
      continue;
    const hash = shorthash.unique(buildState[id].contents);
    const newID = id.replace(/\[HASH\]/, hash);
    cssHashes.set(id, newID);
    buildState[newID] = buildState[id];
    delete buildState[id];
  }
  debug(logging, "css", `built hashes [${stopTimer(timer.hashes)}]`);
  timer.html = performance.now();
  await Promise.all(Object.keys(buildState).map(async (id) => {
    if (buildState[id].contentType !== "text/html")
      return;
    const $ = cheerio.load(buildState[id].contents);
    const pageCSS = new Set();
    $("link[href]").each((i, el) => {
      const srcPath = getSrcPath(id, {astroConfig});
      const oldHref = getDistPath($(el).attr("href") || "", {astroConfig, srcPath});
      const newHref = cssMap.get(oldHref);
      if (newHref) {
        if (pageCSS.has(newHref)) {
          $(el).remove();
        } else {
          $(el).attr("href", cssHashes.get(newHref) || "");
          pageCSS.add(newHref);
        }
        $(el).attr("rel", "stylesheet");
        $(el).attr("type", "text/css");
      }
    });
    buildState[id].contents = $.html();
  }));
  debug(logging, "css", `parsed html [${stopTimer(timer.html)}]`);
}
export {
  bundleCSS
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2J1aWxkL2J1bmRsZS9jc3MudHMiXSwKICAibWFwcGluZ3MiOiAiQUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFHQSxNQUFNLGFBQWE7QUFnQm5CLHlCQUFnQztBQUFBLEVBQzlCO0FBQUEsRUFDQTtBQUFBLEVBQ0E7QUFBQSxFQUNBO0FBQUEsR0FNZ0I7QUFDaEIsUUFBTSxRQUFnQztBQUN0QyxRQUFNLFNBQVMsSUFBSTtBQUduQixRQUFNLFNBQVMsWUFBWTtBQUMzQixRQUFNLGNBQWMsT0FBTyxLQUFLO0FBQ2hDLGNBQVksS0FBSyxDQUFDLEdBQUcsTUFBTSxFQUFFLGNBQWMsR0FBRyxNQUFNLENBQUUsU0FBUztBQUMvRCxhQUFXLFdBQVcsYUFBYTtBQUNqQyxVQUFNLENBQUUsT0FBUSxRQUFRO0FBQ3hCLGVBQVcsVUFBVSxJQUFJLFFBQVE7QUFDL0IsVUFBSSxPQUFPLElBQUksU0FBUztBQUV0QixlQUFPLElBQUksUUFBUTtBQUFBLGFBQ2Q7QUFFTCxlQUFPLElBQUksUUFBUSxZQUFZLFFBQVEsUUFBUSxVQUFVLElBQUksUUFBUSxPQUFPLE1BQU07QUFBQTtBQUFBO0FBQUE7QUFNeEYsUUFBTSxTQUFTLFlBQVk7QUFFM0IsYUFBVyxNQUFNLE9BQU8sUUFBUTtBQUM5QixVQUFNLFNBQVMsT0FBTyxJQUFJO0FBRzFCLFFBQUksQ0FBQyxXQUFXLFNBQVM7QUFDdkIsaUJBQVcsVUFBVTtBQUFBLFFBQ25CLFNBQVMsV0FBVyxJQUFJLENBQUU7QUFBQSxRQUMxQixVQUFVO0FBQUEsUUFDVixhQUFhO0FBQUEsUUFDYixVQUFVO0FBQUE7QUFBQTtBQUtkLElBQUMsV0FBVyxRQUFnQixZQUFZLE9BQU8sU0FBUyxXQUFXLElBQUksWUFBWSxXQUFXLElBQUksU0FBUyxTQUFTLFVBQVUsV0FBVyxJQUFJO0FBQzdJLFdBQU8sV0FBVztBQUFBO0FBRXBCLFFBQU0sU0FBUyxPQUFPLFlBQVksVUFBVSxNQUFNO0FBR2xELFFBQU0sU0FBUyxZQUFZO0FBQzNCLFFBQU0sUUFBUSxJQUNaLE9BQU8sS0FBSyxZQUFZLElBQUksT0FBTyxPQUFPO0FBQ3hDLFFBQUksV0FBVyxJQUFJLGdCQUFnQjtBQUFZO0FBQy9DLFVBQU0sQ0FBRSxRQUFTLE1BQU0sUUFBUSxVQUFVLFdBQVcsSUFBSSxVQUFvQjtBQUFBLE1BQzFFLFFBQVE7QUFBQSxNQUNSLFFBQVE7QUFBQTtBQUVWLGVBQVcsSUFBSSxXQUFXO0FBQUE7QUFHOUIsUUFBTSxTQUFTLE9BQU8sYUFBYSxVQUFVLE1BQU07QUFHbkQsUUFBTSxTQUFTLFlBQVk7QUFDM0IsUUFBTSxZQUFZLElBQUk7QUFDdEIsYUFBVyxNQUFNLE9BQU8sS0FBSyxhQUFhO0FBQ3hDLFFBQUksQ0FBQyxHQUFHLFNBQVM7QUFBZTtBQUVoQyxVQUFNLE9BQU8sVUFBVSxPQUFPLFdBQVcsSUFBSTtBQUM3QyxVQUFNLFFBQVEsR0FBRyxRQUFRLFlBQVk7QUFDckMsY0FBVSxJQUFJLElBQUk7QUFDbEIsZUFBVyxTQUFTLFdBQVc7QUFDL0IsV0FBTyxXQUFXO0FBQUE7QUFFcEIsUUFBTSxTQUFTLE9BQU8saUJBQWlCLFVBQVUsTUFBTTtBQUd2RCxRQUFNLE9BQU8sWUFBWTtBQUN6QixRQUFNLFFBQVEsSUFDWixPQUFPLEtBQUssWUFBWSxJQUFJLE9BQU8sT0FBTztBQUN4QyxRQUFJLFdBQVcsSUFBSSxnQkFBZ0I7QUFBYTtBQUVoRCxVQUFNLElBQUksUUFBUSxLQUFLLFdBQVcsSUFBSTtBQUN0QyxVQUFNLFVBQVUsSUFBSTtBQUNwQixNQUFFLGNBQWMsS0FBSyxDQUFDLEdBQUcsT0FBTztBQUM5QixZQUFNLFVBQVUsV0FBVyxJQUFJLENBQUU7QUFDakMsWUFBTSxVQUFVLFlBQVksRUFBRSxJQUFJLEtBQUssV0FBVyxJQUFJLENBQUUsYUFBYTtBQUNyRSxZQUFNLFVBQVUsT0FBTyxJQUFJO0FBQzNCLFVBQUksU0FBUztBQUVYLFlBQUksUUFBUSxJQUFJLFVBQVU7QUFDeEIsWUFBRSxJQUFJO0FBQUEsZUFDRDtBQUNMLFlBQUUsSUFBSSxLQUFLLFFBQVEsVUFBVSxJQUFJLFlBQVk7QUFDN0Msa0JBQVEsSUFBSTtBQUFBO0FBR2QsVUFBRSxJQUFJLEtBQUssT0FBTztBQUNsQixVQUFFLElBQUksS0FBSyxRQUFRO0FBQUE7QUFBQTtBQUd2QixJQUFDLFdBQVcsSUFBWSxXQUFXLEVBQUU7QUFBQTtBQUd6QyxRQUFNLFNBQVMsT0FBTyxnQkFBZ0IsVUFBVSxNQUFNO0FBQUE7IiwKICAibmFtZXMiOiBbXQp9Cg==
