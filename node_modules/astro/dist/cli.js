import * as colors from "kleur/colors";
import {promises as fsPromises} from "fs";
import yargs from "yargs-parser";
import {loadConfig} from "./config.js";
import {build} from "./build.js";
import devServer from "./dev.js";
import {reload} from "./reload.js";
const {readFile} = fsPromises;
const buildAndExit = async (astroConfig) => {
  const ret = await build(astroConfig);
  process.exit(ret);
};
const reloadAndExit = async () => {
  const ret = await reload();
  process.exit(ret);
};
function resolveArgs(flags) {
  const options = {
    projectRoot: typeof flags.projectRoot === "string" ? flags.projectRoot : void 0,
    site: typeof flags.site === "string" ? flags.site : void 0,
    sitemap: typeof flags.sitemap === "boolean" ? flags.sitemap : void 0,
    port: typeof flags.port === "number" ? flags.port : void 0,
    config: typeof flags.config === "string" ? flags.config : void 0
  };
  if (flags.version) {
    return {cmd: "version", options};
  } else if (flags.help) {
    return {cmd: "help", options};
  }
  const cmd = flags._[2];
  switch (cmd) {
    case "dev":
      return {cmd: "dev", options};
    case "build":
      return {cmd: "build", options};
    default:
      if (flags.reload) {
        return {cmd: "reload", options};
      }
      return {cmd: "help", options};
  }
}
function printHelp() {
  console.error(`  ${colors.bold("astro")} - Futuristic web development tool.

  ${colors.bold("Commands:")}
  astro dev             Run Astro in development mode.
  astro build           Build a pre-compiled production version of your site.

  ${colors.bold("Flags:")}
  --config <path>       Specify the path to the Astro config file.
  --project-root <path> Specify the path to the project root folder.
  --no-sitemap          Disable sitemap generation (build only).
  --reload              Clean the cache, reinstalling dependencies.
  --verbose             Enable verbose logging
  --silent              Disable logging
  --version             Show the version number and exit.
  --help                Show this help message.
`);
}
async function printVersion() {
  const pkg = JSON.parse(await readFile(new URL("../package.json", import.meta.url), "utf-8"));
  console.error(pkg.version);
}
function mergeCLIFlags(astroConfig, flags) {
  if (typeof flags.sitemap === "boolean")
    astroConfig.buildOptions.sitemap = flags.sitemap;
  if (typeof flags.site === "string")
    astroConfig.buildOptions.site = flags.site;
  if (typeof flags.port === "number")
    astroConfig.devOptions.port = flags.port;
  if (typeof flags.hostname === "string")
    astroConfig.devOptions.hostname = flags.hostname;
}
async function runCommand(rawRoot, cmd, options) {
  try {
    const projectRoot = options.projectRoot || rawRoot;
    const astroConfig = await loadConfig(projectRoot, options.config);
    mergeCLIFlags(astroConfig, options);
    return cmd(astroConfig, options);
  } catch (err) {
    console.error(colors.red(err.toString() || err));
    process.exit(1);
  }
}
const cmdMap = new Map([
  ["build", buildAndExit],
  ["dev", devServer],
  ["reload", reloadAndExit]
]);
async function cli(args) {
  const flags = yargs(args);
  const state = resolveArgs(flags);
  switch (state.cmd) {
    case "help": {
      printHelp();
      process.exit(1);
      break;
    }
    case "version": {
      await printVersion();
      process.exit(0);
      break;
    }
    case "reload": {
      await reloadAndExit();
      break;
    }
    case "build":
    case "dev": {
      if (flags.reload) {
        await reload();
      }
      const cmd = cmdMap.get(state.cmd);
      if (!cmd)
        throw new Error(`Error running ${state.cmd}`);
      runCommand(flags._[3], cmd, state.options);
      break;
    }
  }
}
export {
  cli
};
//# sourceMappingURL=data:application/json;base64,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
