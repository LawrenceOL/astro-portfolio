var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, {enumerable: true, configurable: true, writable: true, value}) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));
import {getAttrValue} from "../../ast.js";
const PRISM_IMPORT = `import Prism from 'astro/components/Prism.astro';`;
const prismImportExp = /import Prism from ['"]astro\/components\/Prism.astro['"]/;
function escape(code) {
  return code.replace(/[`$]/g, (match) => {
    return "\\" + match;
  }).replace(/&#123;/g, "{");
}
function unescapeCode(code) {
  var _a;
  code.children = (_a = code.children) == null ? void 0 : _a.map((child) => {
    if (child.type === "Text") {
      return __spreadProps(__spreadValues({}, child), {raw: child.raw.replace(/&#x26;#123;/g, "{")});
    }
    return child;
  });
}
function prism_default(module) {
  let usesPrism = false;
  return {
    visitors: {
      html: {
        Element: {
          enter(node) {
            if (node.name === "code") {
              unescapeCode(node);
              return;
            }
            if (node.name !== "pre")
              return;
            const codeEl = node.children && node.children[0];
            if (!codeEl || codeEl.name !== "code")
              return;
            const className = getAttrValue(codeEl.attributes, "class") || "";
            const classes = className.split(" ");
            let lang;
            for (let cn of classes) {
              const matches = /language-(.+)/.exec(cn);
              if (matches) {
                lang = matches[1];
              }
            }
            if (!lang)
              return;
            let codeData = codeEl.children && codeEl.children[0];
            if (!codeData)
              return;
            let code = codeData.data;
            const repl = {
              start: 0,
              end: 0,
              type: "InlineComponent",
              name: "Prism",
              attributes: [
                {
                  type: "Attribute",
                  name: "lang",
                  value: [
                    {
                      type: "Text",
                      raw: lang,
                      data: lang
                    }
                  ]
                },
                {
                  type: "Attribute",
                  name: "code",
                  value: [
                    {
                      type: "MustacheTag",
                      expression: {
                        type: "Expression",
                        codeChunks: ["`" + escape(code) + "`"],
                        children: []
                      }
                    }
                  ]
                }
              ],
              children: []
            };
            this.replace(repl);
            usesPrism = true;
          }
        }
      }
    },
    async finalize() {
      if (usesPrism && module && !prismImportExp.test(module.content)) {
        module.content = PRISM_IMPORT + "\n" + module.content;
      }
    }
  };
}
export {
  PRISM_IMPORT,
  prism_default as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvbXBpbGVyL3RyYW5zZm9ybS9wcmlzbS50cyJdLAogICJtYXBwaW5ncyI6ICI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQTtBQUVPLE1BQU0sZUFBZTtBQUM1QixNQUFNLGlCQUFpQjtBQUV2QixnQkFBZ0IsTUFBYztBQUM1QixTQUFPLEtBQ0osUUFBUSxTQUFTLENBQUMsVUFBVTtBQUMzQixXQUFPLE9BQU87QUFBQSxLQUVmLFFBQVEsV0FBVztBQUFBO0FBSXhCLHNCQUFzQixNQUFvQjtBQWhCMUM7QUFpQkUsT0FBSyxXQUFXLFdBQUssYUFBTCxtQkFBZSxJQUFJLENBQUMsVUFBVTtBQUM1QyxRQUFJLE1BQU0sU0FBUyxRQUFRO0FBQ3pCLGFBQU8saUNBQUssUUFBTCxDQUFZLEtBQUssTUFBTSxJQUFJLFFBQVEsZ0JBQWdCO0FBQUE7QUFFNUQsV0FBTztBQUFBO0FBQUE7QUFJSSx1QkFBVSxRQUE2QjtBQUNwRCxNQUFJLFlBQVk7QUFFaEIsU0FBTztBQUFBLElBQ0wsVUFBVTtBQUFBLE1BQ1IsTUFBTTtBQUFBLFFBQ0osU0FBUztBQUFBLFVBQ1AsTUFBTSxNQUFNO0FBQ1YsZ0JBQUksS0FBSyxTQUFTLFFBQVE7QUFDeEIsMkJBQWE7QUFDYjtBQUFBO0FBR0YsZ0JBQUksS0FBSyxTQUFTO0FBQU87QUFDekIsa0JBQU0sU0FBUyxLQUFLLFlBQVksS0FBSyxTQUFTO0FBQzlDLGdCQUFJLENBQUMsVUFBVSxPQUFPLFNBQVM7QUFBUTtBQUV2QyxrQkFBTSxZQUFZLGFBQWEsT0FBTyxZQUFZLFlBQVk7QUFDOUQsa0JBQU0sVUFBVSxVQUFVLE1BQU07QUFFaEMsZ0JBQUk7QUFDSixxQkFBUyxNQUFNLFNBQVM7QUFDdEIsb0JBQU0sVUFBVSxnQkFBZ0IsS0FBSztBQUNyQyxrQkFBSSxTQUFTO0FBQ1gsdUJBQU8sUUFBUTtBQUFBO0FBQUE7QUFJbkIsZ0JBQUksQ0FBQztBQUFNO0FBRVgsZ0JBQUksV0FBVyxPQUFPLFlBQVksT0FBTyxTQUFTO0FBQ2xELGdCQUFJLENBQUM7QUFBVTtBQUNmLGdCQUFJLE9BQU8sU0FBUztBQUVwQixrQkFBTSxPQUFPO0FBQUEsY0FDWCxPQUFPO0FBQUEsY0FDUCxLQUFLO0FBQUEsY0FDTCxNQUFNO0FBQUEsY0FDTixNQUFNO0FBQUEsY0FDTixZQUFZO0FBQUEsZ0JBQ1Y7QUFBQSxrQkFDRSxNQUFNO0FBQUEsa0JBQ04sTUFBTTtBQUFBLGtCQUNOLE9BQU87QUFBQSxvQkFDTDtBQUFBLHNCQUNFLE1BQU07QUFBQSxzQkFDTixLQUFLO0FBQUEsc0JBQ0wsTUFBTTtBQUFBO0FBQUE7QUFBQTtBQUFBLGdCQUlaO0FBQUEsa0JBQ0UsTUFBTTtBQUFBLGtCQUNOLE1BQU07QUFBQSxrQkFDTixPQUFPO0FBQUEsb0JBQ0w7QUFBQSxzQkFDRSxNQUFNO0FBQUEsc0JBQ04sWUFBWTtBQUFBLHdCQUNWLE1BQU07QUFBQSx3QkFDTixZQUFZLENBQUMsTUFBTSxPQUFPLFFBQVE7QUFBQSx3QkFDbEMsVUFBVTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxjQU1wQixVQUFVO0FBQUE7QUFHWixpQkFBSyxRQUFRO0FBQ2Isd0JBQVk7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLFVBS2QsV0FBVztBQUVmLFVBQUksYUFBYSxVQUFVLENBQUMsZUFBZSxLQUFLLE9BQU8sVUFBVTtBQUMvRCxlQUFPLFVBQVUsZUFBZSxPQUFPLE9BQU87QUFBQTtBQUFBO0FBQUE7QUFBQTsiLAogICJuYW1lcyI6IFtdCn0K
